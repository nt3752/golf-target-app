<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Golf Target Builder (OSM)</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }

    #panel {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 1000;
      width: min(360px, calc(100vw - 24px));
      background: rgba(255,255,255,0.96);
      border-radius: 14px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.25);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overflow: hidden;
    }

    #panel header {
      padding: 10px 12px;
      border-bottom: 1px solid rgba(0,0,0,0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    #title { font-weight: 800; font-size: 14px; }
    #modeLabel { font-weight: 800; }

    #panel .content { padding: 10px 12px; }

    .row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
    button {
      border: 1px solid rgba(0,0,0,0.12);
      background: white;
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 13px;
      cursor: pointer;
      user-select: none;
    }
    button:hover { background: rgba(0,0,0,0.04); }
    button.primary { background: rgba(0, 122, 255, 0.12); border-color: rgba(0, 122, 255, 0.25); }
    button.danger { background: rgba(255, 59, 48, 0.10); border-color: rgba(255, 59, 48, 0.25); }

    input[type="text"]{
      width: 100%;
      box-sizing: border-box;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.12);
      font-size: 13px;
      margin-bottom: 10px;
    }

    #coordsBox {
      background: rgba(0,0,0,0.04);
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 12px;
      padding: 8px 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      margin-bottom: 10px;
    }

    #list {
      max-height: 220px;
      overflow: auto;
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 12px;
      padding: 8px 10px;
      background: rgba(255,255,255,0.7);
      font-size: 13px;
    }

    .item {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 6px 10px;
      padding: 8px 0;
      border-bottom: 1px dashed rgba(0,0,0,0.12);
    }
    .item:last-child { border-bottom: none; }
    .tag {
      display: inline-block;
      font-size: 11px;
      font-weight: 800;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.10);
      background: rgba(0,0,0,0.03);
      margin-right: 6px;
    }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; }
    .itemBtns { display: flex; gap: 6px; justify-content: flex-end; align-items: center; }
    .itemBtns button { padding: 6px 8px; font-size: 12px; }

    #footer {
      padding: 10px 12px;
      border-top: 1px solid rgba(0,0,0,0.08);
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
    }

    .hint { font-size: 12px; opacity: 0.75; line-height: 1.35; }
  </style>
</head>

<body>
  <div id="panel">
    <header>
      <div>
        <div id="title">Golf Target Builder (OSM)</div>
        <div class="hint">Click the map to save a coordinate.</div>
      </div>
      <div>Mode: <span id="modeLabel">Point</span></div>
    </header>

    <div class="content">
      <div class="row">
        <button class="primary" id="modePoint">Point</button>
        <button id="modeTee">Tee</button>
        <button id="modeGreen">Green</button>
        <button id="modeHazard">Hazard</button>
      </div>

      <input id="labelInput" type="text" placeholder="Optional label (e.g., '100y layup', 'front bunker')" />

      <div id="coordsBox">
        <div><b>Last click</b></div>
        <div class="mono" id="lastCoords">Lat: ‚Äî, Lng: ‚Äî</div>
        <div class="row" style="margin-top:8px;margin-bottom:0;">
          <button id="copyLast" disabled>Copy last</button>
          <button id="undo" class="danger" disabled>Undo last</button>
        </div>
      </div>

      <div class="row">
        <button id="holeView">Hole view</button>
        <button id="greenView">Green view</button>
        <button id="clearAll" class="danger">Clear all</button>
      </div>

      <div class="hint" style="margin-bottom:10px;">
        Tip: Mark <b>Tee</b> and <b>Green</b>, then use <b>Hole view</b> to fit them both.
      </div>

      <div><b>Saved points</b> (<span id="count">0</span>)</div>
      <div id="list"></div>
    </div>

    <div id="footer">
      <button id="copyJson">Copy JSON</button>
      <button id="downloadJson">Download JSON</button>
    </div>
  </div>

  <div id="map"></div>

  <script>
    const TYPE_TAG = { POINT:"Point", TEE:"Tee", GREEN:"Green", HAZARD:"Hazard" };
    const state = { mode: "POINT", lastClick: null, points: [] };

    // Start location (edit anytime)
    const startLatLng = [40.2938, -74.6177];
    const map = L.map("map", { zoomControl: true }).setView(startLatLng, 16);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    function fmt(n){ return Number(n).toFixed(6); }

    function setMode(mode){
      state.mode = mode;
      document.getElementById("modeLabel").textContent = TYPE_TAG[mode] || mode;

      const btns = [
        ["modePoint","POINT"],
        ["modeTee","TEE"],
        ["modeGreen","GREEN"],
        ["modeHazard","HAZARD"]
      ];
      btns.forEach(([id,m])=>{
        const b = document.getElementById(id);
        if (m === mode) b.classList.add("primary");
        else b.classList.remove("primary");
      });
    }

    function updateLastCoordsUI(){
      const el = document.getElementById("lastCoords");
      if(!state.lastClick){
        el.textContent = "Lat: ‚Äî, Lng: ‚Äî";
        document.getElementById("copyLast").disabled = true;
        return;
      }
      el.textContent = `Lat: ${fmt(state.lastClick.lat)}, Lng: ${fmt(state.lastClick.lng)}`;
      document.getElementById("copyLast").disabled = false;
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, (m)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function id(){
      return (crypto.randomUUID ? crypto.randomUUID() : String(Date.now() + Math.random()));
    }

    function updateListUI(){
      document.getElementById("count").textContent = String(state.points.length);
      const list = document.getElementById("list");
      list.innerHTML = "";
      document.getElementById("undo").disabled = state.points.length === 0;

      if(state.points.length === 0){
        list.innerHTML = `<div class="hint">No points yet. Click the map to add one.</div>`;
        return;
      }

      state.points.slice().reverse().forEach((p)=>{
        const item = document.createElement("div");
        item.className = "item";

        const left = document.createElement("div");
        left.innerHTML = `
          <div><span class="tag">${TYPE_TAG[p.type] || p.type}</span><b>${escapeHtml(p.label || "(no label)")}</b></div>
          <div class="mono">${fmt(p.lat)}, ${fmt(p.lng)}</div>
        `;

        const right = document.createElement("div");
        right.className = "itemBtns";

        const goBtn = document.createElement("button");
        goBtn.textContent = "Go";
        goBtn.onclick = () => {
          map.setView([p.lat, p.lng], Math.max(map.getZoom(), 18));
          p.marker.openPopup();
        };

        const copyBtn = document.createElement("button");
        copyBtn.textContent = "Copy";
        copyBtn.onclick = () => copyText(`${fmt(p.lat)}, ${fmt(p.lng)}`);

        const delBtn = document.createElement("button");
        delBtn.textContent = "Del";
        delBtn.className = "danger";
        delBtn.onclick = () => deletePoint(p.id);

        right.append(goBtn, copyBtn, delBtn);
        item.append(left, right);
        list.appendChild(item);
      });
    }

    function addPoint(lat, lng){
      const labelInput = document.getElementById("labelInput");
      const label = (labelInput.value || "").trim();
      labelInput.value = "";

      const type = state.mode;
      const pointId = id();
      const emoji = type === "TEE" ? "üèÅ" : type === "GREEN" ? "‚õ≥" : type === "HAZARD" ? "‚ö†Ô∏è" : "üìç";

      const marker = L.marker([lat, lng]).addTo(map);
      marker.bindPopup(`
        <div style="font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;">
          <div><b>${emoji} ${TYPE_TAG[type] || type}</b> ${label ? "‚Äî " + escapeHtml(label) : ""}</div>
          <div class="mono">${fmt(lat)}, ${fmt(lng)}</div>
        </div>
      `);

      state.points.push({ id: pointId, type, label, lat, lng, ts: new Date().toISOString(), marker });
      updateListUI();
    }

    function deletePoint(pointId){
      const idx = state.points.findIndex(p => p.id === pointId);
      if(idx === -1) return;
      map.removeLayer(state.points[idx].marker);
      state.points.splice(idx, 1);
      updateListUI();
    }

    function undoLast(){
      if(state.points.length === 0) return;
      deletePoint(state.points[state.points.length - 1].id);
    }

    function clearAll(){
      state.points.forEach(p => map.removeLayer(p.marker));
      state.points = [];
      updateListUI();
    }

    function getTeeGreen(){
      return {
        tee: state.points.find(p => p.type === "TEE") || null,
        green: state.points.find(p => p.type === "GREEN") || null
      };
    }

    function holeView(){
      const { tee, green } = getTeeGreen();
      if(!tee || !green){ alert("Mark Tee and Green first."); return; }
      const bounds = L.latLngBounds([[tee.lat, tee.lng], [green.lat, green.lng]]);
      state.points.forEach(p => bounds.extend([p.lat, p.lng]));
      map.fitBounds(bounds, { padding: [40, 40] });
    }

    function greenView(){
      const { green } = getTeeGreen();
      if(!green){ alert("Mark Green first."); return; }
      map.setView([green.lat, green.lng], 19);
    }

    async function copyText(text){
      try{ await navigator.clipboard.writeText(text); alert("Copied to clipboard."); }
      catch { prompt("Copy:", text); }
    }

    function exportData(){
      const tee = state.points.find(p => p.type === "TEE");
      const green = state.points.find(p => p.type === "GREEN");
      const pick = (p) => ({ type: p.type, label: p.label || "", lat: +fmt(p.lat), lng: +fmt(p.lng), ts: p.ts });

      return {
        createdAt: new Date().toISOString(),
        tee: tee ? pick(tee) : null,
        green: green ? pick(green) : null,
        hazards: state.points.filter(p => p.type === "HAZARD").map(pick),
        points: state.points.filter(p => p.type === "POINT").map(pick),
        all: state.points.map(pick)
      };
    }

    function downloadText(filename, text){
      const blob = new Blob([text], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    map.on("click", (e) => {
      const lat = e.latlng.lat;
      const lng = e.latlng.lng;
      state.lastClick = { lat, lng };
      updateLastCoordsUI();
      addPoint(lat, lng);
    });

    document.getElementById("modePoint").onclick = () => setMode("POINT");
    document.getElementById("modeTee").onclick = () => setMode("TEE");
    document.getElementById("modeGreen").onclick = () => setMode("GREEN");
    document.getElementById("modeHazard").onclick = () => setMode("HAZARD");
    document.getElementById("copyLast").onclick = () => state.lastClick && copyText(`${fmt(state.lastClick.lat)}, ${fmt(state.lastClick.lng)}`);
    document.getElementById("undo").onclick = undoLast;
    document.getElementById("clearAll").onclick = () => confirm("Clear all markers and points?") && clearAll();
    document.getElementById("holeView").onclick = holeView;
    document.getElementById("greenView").onclick = greenView;
    document.getElementById("copyJson").onclick = () => copyText(JSON.stringify(exportData(), null, 2));
    document.getElementById("downloadJson").onclick = () => {
      const json = JSON.stringify(exportData(), null, 2);
      const name = `targets_${new Date().toISOString().slice(0,19).replace(/[:T]/g,"-")}.json`;
      downloadText(name, json);
    };

    setMode("POINT");
    updateLastCoordsUI();
    updateListUI();
  </script>
</body>
</html>
